<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo Oficial | {{ negocio.nombre_negocio }}</title>
    
    <link rel="icon" href="{{ url_for('static', filename='imgs/Rodar.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Inter', sans-serif; }
        .navbar-catalogo { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .hero-catalogo { 
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); 
            color: white; padding: 60px 0; text-align: center; 
        }
        .search-box { margin-top: -35px; z-index: 10; position: relative; }
        .search-input { 
            border: none; border-radius: 15px; padding: 28px 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); font-size: 1.1rem; 
        }

        /* Card Estilo E-commerce */
        .product-card { 
            border: none; border-radius: 16px; background: #fff; 
            transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        
        .img-wrapper { height: 200px; overflow: hidden; border-radius: 16px 16px 0 0; background: #f9f9f9; }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .product-card:hover .img-wrapper img { scale: 1.1; }
        
        .card-body { padding: 1.2rem; display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .product-title { font-size: 0.95rem; font-weight: 700; color: #2d3436; margin-bottom: 5px; }
        .product-category { font-size: 0.75rem; color: #a0a0a0; text-transform: uppercase; letter-spacing: 1px; }
        .price { color: #007bff; font-weight: 800; font-size: 1.3rem; margin: 10px 0; }
        
        .btn-whatsapp { 
            background: #25D366; color: white; font-weight: bold; border-radius: 12px; 
            padding: 12px; border: none; transition: 0.3s;
        }
        .btn-whatsapp:hover { background: #1eb954; color: white; box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4); }
    </style>
</head>
<body>

    <nav class="navbar navbar-catalogo px-4 py-3">
        <a href="{{ url_for('pagina_api_bp.ver_micrositio', slug=negocio.slug) }}" class="btn-back text-dark">
            <i class="fas fa-arrow-left"></i> <span class="ml-2 font-weight-bold">Volver</span>
        </a>
        <span class="navbar-brand mb-0 h1 ml-auto" style="font-size: 1.1rem;">{{ negocio.nombre_negocio }}</span>
    </nav>

    <header class="hero-catalogo">
        <div class="container">
            <h1 class="display-4 font-weight-bold">Cat치logo de Productos</h1>
            <p class="lead opacity-75">Explora nuestras soluciones y herramientas disponibles</p>
        </div>
    </header>

    <div class="container">
        <div class="row justify-content-center search-box">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control search-input" placeholder="游댌 Buscar por nombre o categor칤a...">
            </div>
        </div>

        <div class="row mt-5" id="productGrid">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted font-italic">Obteniendo productos actualizados de Neon DB...</p>
            </div>
        </div>
    </div>

    <footer class="py-5 bg-white text-center mt-5 border-top">
        <p class="mb-0 text-muted small">춸 2026 {{ negocio.nombre_negocio }} | Powered by <strong>BizFlow Studio</strong></p>
    </footer>

    <script>
        // CONFIGURACI칍N DIN츼MICA
        const NEGOCIO_ID = "{{ negocio.id_negocio }}";
        
        // CORRECCI칍N WHATSAPP: Forzamos tu n칰mero y limpiamos cualquier car치cter no num칠rico
        const WHATSAPP_CONFIG = "{{ negocio.telefono }}".replace(/\D/g, ''); 
        const WHATSAPP_NEGOCIO = WHATSAPP_CONFIG.length > 5 ? WHATSAPP_CONFIG : "573058916907";

        const API_URL = "https://trayectoria-backend.onrender.com/api";
        const grid = document.getElementById('productGrid');
        const input = document.getElementById('searchInput');
        let productosCache = [];

        const formatter = new Intl.NumberFormat('es-CO', {
            style: 'currency', currency: 'COP', minimumFractionDigits: 0
        });

        async function cargarProductos() {
            try {
                const response = await fetch(`${API_URL}/productos/publicos/${NEGOCIO_ID}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    productosCache = result.data;
                    renderizar(productosCache);
                } else {
                    grid.innerHTML = `<div class="col-12 text-center py-5"><h4 class="text-muted">A칰n no hay productos publicados.</h4></div>`;
                }
            } catch (error) {
                grid.innerHTML = '<div class="col-12 text-center py-5"><h4 class="text-danger">Error de conexi칩n.</h4></div>';
            }
        }

        function renderizar(items) {
            grid.innerHTML = items.map(p => `
                <div class="col-6 col-md-4 col-lg-3 mb-4">
                    <div class="product-card shadow-sm">
                        <div class="img-wrapper">
                            <img src="${p.img || 'https://res.cloudinary.com/dp50v0bwj/image/upload/v1704285000/default_product.png'}" 
                                 alt="${p.nombre}" 
                                 onerror="this.src='https://via.placeholder.com/300x200?text=Sin+Imagen'">
                        </div>
                        <div class="card-body">
                            <div>
                                <span class="product-category">${p.categoria || 'General'}</span>
                                <h6 class="product-title text-truncate">${p.nombre}</h6>
                                <p class="price">${formatter.format(p.price || p.precio)}</p>
                            </div>
                            <a href="https://wa.me/${WHATSAPP_NEGOCIO}?text=Hola! Me interesa este producto de su cat치logo: *${p.nombre}*%0A%0A*Descripci칩n:* ${p.descripcion || 'Ver en cat치logo'}%0A*Precio:* ${formatter.format(p.price || p.precio)}" 
                               target="_blank" class="btn btn-whatsapp btn-block">
                                <i class="fab fa-whatsapp mr-1"></i> Consultar
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        input.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtrados = productosCache.filter(p => 
                p.nombre.toLowerCase().includes(term) || 
                (p.categoria && p.categoria.toLowerCase().includes(term))
            );
            renderizar(filtrados);
        });

        document.addEventListener('DOMContentLoaded', cargarProductos);
    </script>
</body>
</html>